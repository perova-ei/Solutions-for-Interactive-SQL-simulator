1.1.1 Сформулируйте SQL запрос для создания таблицы book, занесите  его в окно кода (расположено ниже)  и отправьте на проверку (кнопка Отправить). Структура таблицы book:

CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(50),
    author VARCHAR(30),
    price DECIMAL (8.2),
    amount INT
)

1.1.2 Занесите новую строку в таблицу book (текстовые значения (тип VARCHAR) заключать либо в двойные, либо в одинарные кавычки):

INSERT INTO book (title, author, price, amount) 
VALUES ('Мастер и Маргарита',  'Булгаков М.А.', 670.99, 3)
             
1.1.3 Занесите три последние записи в таблицуbook,  первая запись уже добавлена на предыдущем шаге:

INSERT INTO book (title, author, price, amount)
VALUES ('Белая гвардия', 'Булгаков М.А.', 540.50, 5);
INSERT INTO book (title, author, price, amount)
VALUES ('Идиот', 'Достоевский Ф.М.', 460.00, 10);
INSERT INTO book (title, author, price, amount)
VALUES ('Братья Карамазовы', 'Достоевский Ф.М.', 799.01, 2);
SELECT * FROM book;

1.2.4 Для упаковки каждой книги требуется 1 лист бумаги, цена которого 1 рубль 65 копеек. Посчитать стоимость упаковки для каждой книги
(сколько денег потребуется, чтобы упаковать все экземпляры книги). 
В запросе вывести название книги, ее количество и стоимость упаковки, последний столбец назвать pack. 

SELECT title, 
       amount, 
       amount * 1.65 AS pack 
FROM   book 

1.2.5 В конце года цену всех книг на складе пересчитывают – снижают ее на 30%. Написать SQL запрос, который из таблицы book выбирает названия, авторов, количества и вычисляет новые цены книг. 
Столбец с новой ценой назвать new_price, цену округлить до 2-х знаков после запятой.

SELECT title, 
       author, 
       amount, 
       ROUND(( price * 0.7 ), 2) AS new_price 
FROM   book

1.2.6 При анализе продаж книг выяснилось, что наибольшей популярностью пользуются книги Михаила Булгакова, на втором месте книги Сергея Есенина. 
Исходя из этого решили поднять цену книг Булгакова на 10%, а цену книг Есенина - на 5%.

SELECT author, 
       title, 
       ROUND(IF(author = 'Булгаков М.А.', price * 1.10, 
                   IF(author = 'Есенин С.А.', price * 1.05, price)), 2) 
       AS new_price 
FROM   book 

1.2.7 Вывести автора, название  и цены тех книг, количество которых меньше 10.

SELECT author, 
       title, 
       price 
FROM   book 
WHERE  amount < 10

1.2.8 Вывести название, автора,  цену  и количество всех книг, цена которых меньше 500 или больше 600, а стоимость всех экземпляров этих книг больше или равна 5000.

SELECT title, 
       author, 
       price, 
       amount 
FROM   book 
WHERE  ( price < 500 
          OR price > 600 ) 
       AND ( price * amount >= 5000 )

1.2.9 Вывести название и авторов тех книг, цены которых принадлежат интервалу от 540.50 до 800 (включая границы),  а количество или 2, или 3, или 5, или 7 .

SELECT title, 
       author 
FROM   book 
WHERE  ( price BETWEEN 540.50 AND 800 ) 
       AND ( amount IN ( 2, 3, 5, 7 ) ) 
       
1.2.10 Вывести название и автора тех книг, название которых состоит из двух и более слов, а инициалы автора содержат букву «С».

SELECT title, 
       author 
FROM   book 
WHERE  ( 
              title LIKE '_% _%') 
AND    ( 
              author LIKE '%С.%'))
              
1.2.11 Вывести  автора и название  книг, количество которых принадлежит интервалу от 2 до 14 (включая границы).

SELECT author, 
       title 
FROM   book 
WHERE  amount BETWEEN 2 AND 14 
ORDER  BY author DESC, title

1.3.3 Посчитать, количество различных книг и количество экземпляров книг каждого автора , хранящихся на складе. 

SELECT author  AS Автор, 
       COUNT(author) AS Различных_книг, 
       SUM(amount)   AS Количество_экземпляров 
FROM   book 
GROUP  BY author 

1.3.4 Вывести минимальную, максимальную и среднюю цену книг каждого автора . Вычисляемые столбцы назвать Минимальная_цена, Максимальная_цена и Средняя_цена соответственно.

SELECT author, 
       MIN(price) AS Минимальная_цена, 
       MAX(price) AS Максимальная_цена, 
       AVG(price) AS Средняя_цена 
FROM   book 
GROUP  BY author 

1.3.5 Для каждого автора вычислить суммарную стоимость книг S (имя столбца Стоимость), а также вычислить налог на добавленную стоимость  для полученных сумм (имя столбца НДС ) , 
который включен в стоимость и составляет k = 18%,  а также стоимость книг  (Стоимость_без_НДС) без него.

SELECT author, 
       SUM(price * amount)  AS Стоимость, 
       ROUND(( Sum(price * amount) * 0.18 ) / ( 1 + 0.18 ), 2) AS НДС, 
       ROUND(Sum(price * amount) / ( 1 + 0.18 ), 2) AS Стоимость_без_НДС 
FROM   book 
GROUP  BY author 

1.3.6 Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену книг на складе. 

SELECT MIN(price) AS Минимальная_цена, 
       MAX(price) AS Максимальная_цена, 
       ROUND(Avg(price), 2) AS Средняя_цена 
FROM   book 

1.3.7 Вычислить среднюю цену и суммарную стоимость тех книг, количество экземпляров которых принадлежит интервалу от 5 до 14, включительно.

SELECT ROUND(Avg(price), 2) AS Средняя_цена, 
       SUM(price * amount)  AS Стоимость 
FROM   book 
WHERE  amount BETWEEN 5 AND 14 

1.3.8 Посчитать стоимость всех экземпляров каждого автора без учета книг «Идиот» и «Белая гвардия». В результат включить только тех авторов, у которых суммарная стоимость книг более 5000 руб.

SELECT author, 
       SUM(price * amount) AS Стоимость 
FROM   book 
WHERE  title <> 'Идиот' 
       AND title <> 'Белая гвардия' 
GROUP  BY author 
HAVING SUM(price * amount) > 5000 
ORDER  BY Стоимость DESC 

1.4.1 Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или равны средней цене книг на складе.
Информацию вывести в отсортированном по убыванию цены виде. Среднее вычислить как среднее по цене книги.

SELECT author, 
       title, 
       price 
FROM   book 
WHERE  price <= (SELECT AVG(price) 
                 FROM   book) 
ORDER  BY price DESC 

1.4.2 Вывести информацию (автора, название и цену) о тех книгах, цены которых превышают минимальную цену книги на складе не более чем на 150 рублей 
в отсортированном по возрастанию цены виде.

SELECT author, 
       title, 
       price 
FROM   book 
WHERE  ( price - (SELECT MiIN(price) 
                  FROM   book) <= 150 ) 
ORDER  BY price

1.4.3 Вывести информацию (автора, книгу и количество) о тех книгах, количество экземпляров которых в таблице book не повторяется.

SELECT author, 
       title, 
       amount 
FROM   book 
WHERE  amount IN (SELECT amount 
                  FROM   book 
                  GROUP  BY amount 
                  HAVING COUNT(amount) = 1) 
                  
1.4.4 Вывести информацию о книгах(автор, название, цена) только тех авторов, средняя цена книг которых выше, чем средняя цена книг на складе в целом.

SELECT author, 
       title, 
       price 
FROM   book 
WHERE  author IN (SELECT author 
                  FROM   book 
                  GROUP  BY author 
                  HAVING AVG(price) > (SELECT AVG(price) 
                                       FROM   book)) 
                                       
1.4.5 Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе было одинаковое количество экземпляров каждой книги,
равное максимальному значению из всех количеств экземпляров книг, хранящихся на складе. 

SELECT title, 
       author, 
       amount, 
       ( (SELECT MAX(amount) 
          FROM   book) - amount ) AS Заказ 
FROM   book 
WHERE  ( (SELECT MAX(amount) 
          FROM   book) - amount ) > 0
          
1.5.1 Создать таблицу поставка (supply), которая имеет ту же структуру, что и таблица book.

CREATE TABLE supply (
    supply_id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(50),
    author VARCHAR(30),
    price DECIMAL(8, 2),
    amount INT
)

1.5.2 Занесите в таблицу supply четыре записи, чтобы получилась следующая таблица:

INSERT INTO supply (title, author, price, amount)
VALUES ('Лирика', 'Пастернак Б.Л.', 518.99, 2);
INSERT INTO supply (title, author, price, amount)
VALUES ('Черный человек', 'Есенин С.А.', 570.20, 6);
INSERT INTO supply (title, author, price, amount)
VALUES ('Белая гвардия', 'Булгаков М.А.', 540.50, 7);
INSERT INTO supply (title, author, price, amount)
VALUES ('Идиот', 'Достоевский Ф.М.', 360.80, 3);

1.5.3 Добавить из таблицы supply в таблицу book, все книги, кроме книг, написанных Булгаковым и Достоевским.

INSERT INTO book (title, author, price, amount) 
       SELECT title, author, price, amount 
       FROM supply
       WHERE author <> 'Достоевский Ф.М.' AND author <> 'Булгаков М.А.';

SELECT * FROM book;

1.5.4 Занести из таблицы supply в таблицу book только те книги, авторов которых нет в  book.

INSERT INTO book (title, author, price, amount) 
       SELECT title, author, price, amount 
       FROM supply
       WHERE author NOT IN (SELECT author from book);

SELECT * FROM book;

1.5.5 Уменьшить на 10% цену тех книг в таблице book, количество которых принадлежит интервалу от 5 до 10 включительно.

UPDATE book 
SET    price = 0.9 * price 
WHERE  amount BETWEEN 5 AND 10; 

SELECT * FROM  book; 

1.5.6 В таблице book необходимо скорректировать значение для покупателя в столбце buy таким образом, чтобы оно не превышало допустимый остаток в столбце amount. 
А цену тех книг, которые покупатель не заказывал, снизить на 10%, округлив полученную цену до двух знаков после запятой.

UPDATE book 
SET    buy = IF(buy > amount, amount, buy); 

UPDATE book 
SET    price = 0.9 * price 
WHERE  buy = 0; 

SELECT * FROM  book; 

1.5.7 Для одинаковых книг в таблицах book и supply не только увеличить их количество в таблице book( увеличить их количество на значение столбца amountтаблицы supply),
но и пересчитать их цену (для каждой книги найти сумму цен из таблиц book и supply и разделить на 2).

UPDATE book, supply SET book.amount = book.amount + supply.amount
WHERE book.title = supply.title AND book.author = supply.author;

UPDATE book, supply SET book.price = (book.price + supply.price) / 2
WHERE book.title = supply.title AND book.author = supply.author;

SELECT * FROM book;

1.5.8 Удалить из таблицы supply книги тех авторов, общее количество экземпляров книг которых в таблице book превышает 10.

DELETE FROM supply 
WHERE  author IN (SELECT author 
                  FROM   book 
                  GROUP  BY author 
                  HAVING Sum(amount) > 10); 

SELECT * FROM  supply;

1.5.9 Создать таблицу заказ (ordering), куда включить авторов и названия тех книг, количество экземпляров которых в таблице book меньше среднего количества экземпляров книг в таблице book. 
Для всех книг указать одинаковое значение  amount - среднее количество экземпляров книг в таблице book.

CREATE TABLE ordering AS 
  SELECT author, 
         title, 
         (SELECT ROUND(AVG(amount)) 
          FROM   book) AS amount 
  FROM   book 
  WHERE  amount < (SELECT ROUND(AVG(amount)) 
                   FROM   book); 

SELECT * FROM  ordering; 

1.6.1 Вывести из таблицы trip информацию о командировках тех сотрудников, фамилия которых заканчивается на букву «а», в отсортированном по убыванию даты последнего дня командировки виде

SELECT NAME, 
       city, 
       per_diem, 
       date_first, 
       date_last 
FROM   trip 
WHERE  NAME LIKE '%а %' 
ORDER  BY date_last DESC 

1.6.2 Вывести в алфавитном порядке фамилии и инициалы тех сотрудников, которые были в командировке в Москве.

SELECT DISTINCT NAME 
FROM   trip 
WHERE  city = 'Москва' 
ORDER  BY NAME 

1.6.3 Для каждого города посчитать, сколько раз сотрудники в нем были.  Информацию вывести в отсортированном в алфавитном порядке по названию городов. 

SELECT city, 
       COUNT(city) AS Количество 
FROM   trip 
GROUP  BY city 
ORDER  BY city 

1.6.4 Вывести два города, в которых чаще всего были в командировках сотрудники. 

SELECT city, 
       COUNT(city) AS Количество 
FROM   trip 
GROUP  BY city 
ORDER  BY Количество  DESC 
LIMIT  2 

1.6.5 Вывести информацию о командировках во все города кроме Москвы и Санкт-Петербурга (фамилии и инициалы сотрудников, город ,  длительность командировки в днях, при этом первый и последний день относится к периоду командировки).

SELECT NAME, 
       city, 
       ( Datediff(date_last, date_first) + 1 ) AS Длительность 
FROM   trip 
WHERE  city NOT IN ( 'Москва', 'Санкт-Петербург' ) 
ORDER  BY  Длительность  DESC, city DESC 

1.6.6 Вывести информацию о командировках сотрудника(ов), которые были самыми короткими по времени.

SELECT NAME, 
       city, 
       date_first, 
       date_last 
FROM   trip 
WHERE  Datediff(date_last, date_first) = (SELECT MIN(Datediff(date_last, 
                                                     date_first)) 
                                          FROM   trip) 
                                          
1.6.7 Вывести информацию о командировках, начало и конец которых относятся к одному месяцу. 

SELECT NAME, 
       city, 
       date_first, 
       date_last 
FROM   trip 
WHERE  MONTH(date_first) = MONTH(date_last) 
ORDER  BY city, NAME 

1.6.8 Вывести название месяца и количество командировок для каждого месяца. Считаем, что командировка относится к некоторому месяцу, если она началась в этом месяце. 

SELECT MONTHNAME(date_first) AS Месяц, 
       COUNT(MONTHNAME(date_first)) AS Количество 
FROM   trip 
GROUP  BY MONTHNAME(date_first) 
ORDER  BY Месяц DESC, Количество 

1.6.9 Вывести сумму суточных (произведение количества дней командировки и размера суточных) для командировок, первый день которых пришелся на февраль или март 2020 года. 

SELECT NAME, 
       city, 
       date_first, 
       ( ( Datediff(date_last, date_first) + 1 ) * per_diem ) AS Сумма 
FROM   trip 
WHERE  MONTH(date_first) IN ( 2, 3 ) 
ORDER  BY NAME, Сумма DESC 

1.7.1 Создать таблицу fine следующей структуры:

CREATE TABLE fine
    (
        fine_id INT PRIMARY KEY AUTO_INCREMENT,
        name varchar(30),
        number_plate varchar(6),
        violation varchar(50),
        sum_fine decimal(8, 2),
        date_violation date,
        date_payment date
    );
    
1.7.2 В таблицу fine первые 5 строк уже занесены. Добавить в таблицу записи с ключевыми значениями 6, 7, 8.

INSERT INTO fine(name,number_plate,violation,sum_fine,date_violation,date_payment)
VALUES('Баранов П.Е.', 'Р523ВТ', 'Превышение скорости(от 40 до 60)', NULL, '2020-02-14', NULL);
INSERT INTO fine(name,number_plate,violation,sum_fine,date_violation,date_payment)
VALUES('Абрамова К.А.', 'О111АВ', 'Проезд на запрещающий сигнал', NULL, '2020-02-23', NULL);
INSERT INTO fine(name,number_plate,violation,sum_fine,date_violation,date_payment)
VALUES('Яковлев Г.Р.', 'Т330ТТ', 'Проезд на запрещающий сигнал', NULL, '2020-03-03', NULL)

1.7.3 Занести в таблицу fine суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы traffic_violation. При этом суммы заносить только в пустые поля столбца  sum_fine.

UPDATE fine, 
       traffic_violation 
SET    fine.sum_fine = IF(fine.sum_fine IS NULL, (SELECT sum_fine 
                                                  FROM   traffic_violation 
                                                  WHERE 
                              fine.violation = traffic_violation.violation), 
                                              fine.sum_fine); 

SELECT * FROM  fine;

1.7.4 Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило   два и более раз. 

SELECT NAME, 
       number_plate, 
       violation 
FROM   fine 
GROUP  BY NAME, 
          number_plate, 
          violation 
HAVING COUNT(number_plate) >= 2 

1.7.5 В таблице fine увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей. 

UPDATE fine, 
       (SELECT NAME, 
               number_plate, 
               violation 
        FROM   fine 
        GROUP  BY NAME, 
                  number_plate, 
                  violation 
        HAVING COUNT(number_plate) > 1) AS query_in 
SET    fine.sum_fine = fine.sum_fine * 2 
WHERE  fine.date_payment IS NULL 
       AND fine.NAME = query_in.NAME; 

SELECT * ;FROM  fine 

1.7.6 Водители оплачивают свои штрафы. В таблице payment занесены даты их оплаты

UPDATE fine, 
       payment 
SET    fine.date_payment = payment.date_payment, 
       fine.sum_fine = IF(DATEDIFF(payment.date_payment, fine.date_violation) 
                          - 1 <= 20 , 
                                       fine.sum_fine / 2, fine.sum_fine) 
WHERE  fine.name = payment.name 
       AND fine.number_plate = payment.number_plate 
       AND fine.violation = payment.violation 
       AND fine.date_payment IS NULL; 

SELECT * FROM  fine 

1.7.7 Создать новую таблицу back_payment, куда внести информацию о неоплаченных штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения) из таблицы fine.

CREATE TABLE back_payment AS 
  SELECT NAME, 
         number_plate, 
         violation, 
         sum_fine, 
         date_violation 
  FROM   fine 
  WHERE  date_payment IS NULL; 

SELECT * FROM  back_payment; 
                  
